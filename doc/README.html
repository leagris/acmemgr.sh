<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="README.css" type="text/css" />
</head>
<body>
<p>Quick link table</p>
<!-- MarkdownTOC -->
<ul>
<li><a href="#acmemgrsh">ACMEMGR.SH</a>  - <a href="#introduction">Introduction</a>  - <a href="#purpose">Purpose</a>  - <a href="#features">Features</a>  - <a href="#architecture-big-view">Architecture (big view)</a>  - <a href="#architecture-modular-view">Architecture (modular view)</a>  - <a href="#requirements">Requirements</a>  - <a href="#download">Download</a>  - <a href="#install">Install</a>   - <a href="#base-install-for-one-or-many-dns-01-accounts">Base install, for one or many DNS-01 accounts.</a>   - <a href="#populating-the-domains-names-database">Populating the domains names database</a>  - <a href="#setting-up-one-dns-01-account">Setting up one DNS-01 account</a>   - <a href="#create-account-structure">Create account structure</a>   - <a href="#filling-the-account-keys-and-secret">Filling the account keys and secret</a>   - <a href="#rotate-log">Rotate log</a>  - <a href="#setting-up-one-host">Setting up one host</a>   - <a href="#host_namecertops">HOST_NAME.certops</a>   - <a href="#host_namereload">HOST_NAME.reload</a>  - <a href="#basic-use">Basic use</a>   - <a href="#command-line">Command line</a>   - <a href="#return-codes">Return codes</a>   - <a href="#using---create">Using --create</a>   - <a href="#using---renew">Using --renew</a>   - <a href="#using---update">Using --update</a>   - <a href="#using---copy">Using --copy</a>   - <a href="#using---delete">Using --delete</a>   - <a href="#using---status">Using --status</a>   - <a href="#using---verbose">Using --verbose</a>  - <a href="#high-level-use">High level use</a>   - <a href="#batch-mode">Batch mode</a>   - <a href="#create-a-certificate">Create a certificate</a>   - <a href="#delete-a-certificate">Delete a certificate</a>  - <a href="#real-world-workflow">Real world workflow</a>   - <a href="#good-practises">Good practises</a>  - <a href="#multi-accounts-tree-example">Multi-accounts tree example</a>  - <a href="#build-instructions">Build Instructions</a>   - <a href="#software">Software</a>   - <a href="#documentation">Documentation</a>  - <a href="#releases-log">Releases log</a>  - <a href="#miscellaneous">Miscellaneous</a>   - <a href="#localization">Localization</a>   - <a href="#known-bugs">Known bugs</a>   - <a href="#roadmap">Roadmap</a>   - <a href="#contact">Contact</a>   - <a href="#licence">Licence</a></li>
<li><a href="#appendices">APPENDICES</a>  - <a href="#when-something-going-wrong">When something going wrong</a>  - <a href="#lets-encrypt-certificate-files">Let's Encrypt certificate files</a>  - <a href="#lets-encrypt-certificate-conf-format">Let's Encrypt certificate .conf format</a>  - <a href="#nginx-reloading">Nginx reloading</a>   - <a href="#check-your-system">Check your system</a>   - <a href="#check-execreload-property">Check ExecReload property</a>  - <a href="#glossary">Glossary</a>  - <a href="#test-set">Test set</a>   - <a href="#test-01---run-the-program-without-arguments">Test 01 - Run the program without arguments</a>   - <a href="#test-02---check-the-status-listing">Test 02 - Check the status listing</a>   - <a href="#test-03---check-the-verbose-listing">Test 03 - Check the verbose listing</a>   - <a href="#test-04---create-one-new-domain-certificate">Test 04 - Create one new domain certificate</a>   - <a href="#test-05---delete-one-domain-certificate">Test 05 - Delete one domain certificate</a>   - <a href="#test-06---create-three-new-domains-certificates-and-delete-three-others">Test 06 - Create three new domains certificates and delete three others</a>   - <a href="#test-07---check-acmemgrupdates">Test 07 - Check acmemgr.updates</a>   - <a href="#test-08---check-acmemgrrenew">Test 08 - Check acmemgr.renew</a></li>
</ul>
<!-- /MarkdownTOC -->
<h1 id="acmemgr.sh">ACMEMGR.SH</h1>
<h2 id="introduction">Introduction</h2>
<p><strong>acmemgr.sh</strong> is an <strong>acme.sh</strong> manager for <strong>unlimited</strong> CERTS, TLS services, hosts and DNS-01 accounts from domains names providers.</p>
<p><strong>acmemgr.sh</strong> is designed to be at the sides of <a href="https://github.com/Neilpang/acme.sh" class="uri">https://github.com/Neilpang/acme.sh</a>, the most valuable V1 and V2 protocol compliant ACME client ever written for <a href="https://letsencrypt.org" class="uri">https://letsencrypt.org</a>, the sole free, automated, and open certificate authority brought to you by the non-profit Internet Security Research Group (ISRG).</p>
<p><strong>acmemgr.sh</strong>, as its companion and model <strong>acme.sh</strong>, is &quot;written purely in Shell (Unix shell) language&quot; as pointed out by <strong>Neilpang</strong> the <strong>acme.sh</strong> author himself : no dependency at all (as we can't seriously consider a shell script interpreter as a dependence in a Unix system).</p>
<p><strong>acmemgr.sh</strong> manage :</p>
<ul>
<li><strong>N domains certificates</strong> (through <strong>acme.sh</strong> and <strong>Let's Encrypt</strong> service);</li>
<li>on <strong>N https services</strong> (web or email or whatever - <strong>childs scripts configurable</strong>);</li>
<li>on <strong>N hosts</strong> (dedicated or virtuals);</li>
<li>with <strong>N DNS-01 accounts</strong> (even from <strong>different hosting services</strong>).</li>
</ul>
<p><strong>Let's Encrypt wildcard certificates can only be obtained through DNS-01 method as Let's Encrypt considers it's the only method that offers an appropriate security level.</strong></p>
<h2 id="purpose">Purpose</h2>
<p>There are mainly two methods of certificate management with Let's Encrypt: HTTP-01 and DNS-01.</p>
<p>At first glance, HTTP-01 seems the simplest, but this feeling is misleading. DNS-01 is quickly emerging as the only way to go, as soon as we go beyond managing a few websites, or when using a proxy.</p>
<p>DNS-01 also opens other doors, such as the ability to create certificates even before the creation of the service (website, mail server, etc...).</p>
<p>On the other side, <strong>acme.sh</strong> is a swiss knife at its best. It knows how to do simply everything. Compatible with ACME V1 and V2 protocol, it manages not only HTTP-01 and DNS-01, but also usual web servers like Apache or Nginx, pre and post-processing scripts, certificate lists, etc ...</p>
<p>However, it seems that in the case of a somewhat serious and / or heterogeneous infrastructure, it would certainly be more efficient to leave <strong>acme.sh</strong> what it does best (dealing with Let's Encrypt) and delegate the higher level, that is to say, the management of certificates for your infrastructure, to another program.</p>
<p>This approach is compliant with the spirit of Unix systems: a single feature for a single program. This is why <strong>acmemgr.sh</strong> is proposed.</p>
<p>Because we need multi-accounts DNS provider, among many other things.</p>
<p>Once installed, thanks to <strong>acmemgr.sh</strong>, the management of hundreds of certificates, servers and other DNS providers, in a multi-accounts environment, is simply managed by a single list, in a single file.</p>
<p>The creation, deletion and renewal of certificates, but also their propagation and deletion on remote servers, as well as the sending of service emails and logs: everything is managed transparently by acmemgr.sh!</p>
<p>To create a certificate: create a line in the list.</p>
<p>To delete a certificate, add &quot;DELETING&quot; at the end of this line.</p>
<p>There is noting else to do.</p>
<p>All resulted actions will be reported by email.</p>
<p>The management of this file can even be delegated to an interactive program as part of an infrastructure management software: imagination is the limit.</p>
<h2 id="features">Features</h2>
<p>Main :</p>
<ul>
<li>Handle wild certificates (like *.domain.tld);</li>
<li>When creating certificate which starts with &quot;www.&quot; (like &quot;www.domain.tld&quot;), automatically adds the domain name &quot;domain.tld&quot; in certificate;</li>
<li>Certificate request for renewal is done only when the current certificate is only valid for one month;</li>
<li>The certificates operations (copy and delete) to distant hosts operations&quot; are fully customizable;</li>
<li>The service linked to the certificate (web or email or whatever) is reloaded only when the certificate is successfully created, renewed or deleted (no reload for no reason);</li>
<li>More, the service is restarted only once, even there are more than one updated certificate linked to the service (one reload only for N certificates depending of the same service on the same host);</li>
<li>The reload or restart of the service after certificate update is fully customizable;</li>
<li>When <strong>acmemgr.sh</strong> is renamed acmemgr.renew, it behaves as if it was started with the --renew parameter and could be placed directly in /etc/cron.daily|weekly</li>
<li>When <strong>acmemgr.sh</strong> is renamed acmemgr.update, it behaves as if it was started with both --create and --delete argument and could be placed directly in /etc/cron.hourly</li>
<li>Don't need sudo/root.</li>
</ul>
<p>Coding style :</p>
<ul>
<li>Defensive programming in mind with consistent logging and mailing messages;</li>
<li>Extensive checks before remotely erase certificates declared to be deleted. No use of recursive remove for safety.</li>
</ul>
<h2 id="architecture-big-view">Architecture (big view)</h2>
<p>This a a simplified view how <strong>acmemgr.sh</strong> works.</p>
<p>All the management is done in a centralized CERTIFICATE DISTRIBUTION SERVER :</p>
<ul>
<li>Only one host to manage a pool of registrars, hosts and domains names;</li>
<li>Simple, modulat and understandable architecture;</li>
<li>Only one file to manage : the domain name database.</li>
</ul>
<div class="figure">
<img src="./acmemgr.fig1.png" alt="Architecture" />
<p class="caption">Architecture</p>
</div>
<h2 id="architecture-modular-view">Architecture (modular view)</h2>
<p>This a modular view how <strong>acmemgr.sh</strong> works.</p>
<p>The CERTIFICATE DISTRIBUTION SERVER host only :</p>
<ul>
<li>Two scripts : acme.sh and acmemgr.sh;</li>
<li>One database file, acmemgr.db, in a comma delimited text format;</li>
<li>One directory holding all certificates;</li>
<li>As many subdirectories as registrars DNS-01 accounts;</li>
<li>As many customizable scripts as needed to reload services and copy certificates.</li>
</ul>
<p>For a more detailed view at the file level, see below the &quot;Multi-accounts tree example&quot; section.</p>
<div class="figure">
<img src="./acmemgr.fig2.png" alt="Modular view" />
<p class="caption">Modular view</p>
</div>
<h2 id="requirements">Requirements</h2>
<ul>
<li>Bash or compatible shell;</li>
<li>A least one valid DNS-01 account;</li>
<li>A host with mail sending capability;</li>
<li>Valid ssh keys to update distant hosts.</li>
</ul>
<h2 id="download">Download</h2>
<p><a href="https://stef.genesix.org/pub/acmemgr.sh" class="uri">https://stef.genesix.org/pub/acmemgr.sh</a></p>
<h2 id="install">Install</h2>
<h3 id="base-install-for-one-or-many-dns-01-accounts."> Base install, for one or many DNS-01 accounts.</h3>
<p>Download acme.sh, create some directories and copy some files :</p>
<pre><code>root@system: cd /root
root@system: git clone https://github.com/Neilpang/acme.sh.git</code></pre>
<pre><code>GITHUB SETUP NOT ALREADY DONE
# root@system: git clone https://github.com/Sowebio/acmemgr.sh.git
TEMPORARILY USE THIS DONWNLOAD LINK :</code></pre>
<p>Copy <a href="https://stef.genesix.org/pub/acmemgr.sh" class="uri">https://stef.genesix.org/pub/acmemgr.sh</a> content to /root/acmemgr</p>
<pre><code>root@system: mkdir /etc/acme
root@system: mkdir /var/log/acme

root@system: cp /root/acme/acme.sh /usr/local/bin
root@system: cp /root/acmemgr/acmemgr.sh /usr/local/bin
root@system: cp /root/acmemgr/acmemgr.db /etc/acme
root@system: cp /root/acmemgr/*.certops /etc/acme
root@system: cp /root/acmemgr/*.reload /etc/acme</code></pre>
<p>Create /etc.logrotate.d/acme :</p>
<pre><code>/var/log/acme/acmemgr.log {
  rotate 12
  monthly
  compress
  missingok
  notifempty
}</code></pre>
<h3 id="populating-the-domains-names-database">Populating the domains names database</h3>
<p>Fill /etc/acme/acmemgr.db :</p>
<pre><code>#-------------------------------------------------------------------------------
# ACMEMGR.SH - an ACME.SH manager using DNS-01 issued LETSENCRYPT certificates
#
# acmemgr.db - domains names database
#-------------------------------------------------------------------------------
#
# HOST_NAME       : Host name for scripting, mailing and filtering purposes (only a-z,0-9,&#39;-&#39;,&#39;_&#39;)
# HOST_LOGIN      : Host login
# HOST_FQDN       : Host url (full qualified form or &quot;domuNNNv1&quot; for local HOST)
# HOST_PORT       : Host port
# ACCOUNT_NAME    : Registrar DNS-01 API account to which the domain name belongs
# DOMAIN_NAME     : Domain name hosted
# [DOMAIN_STATUS] : Domain status (undefined or set to &quot;DELETING&quot; to suppress the certificate)
#
#-------------------------------------------------------------------------------

# NOTICE #######################################################################
# To benefit from the smart reload function, you must sort this list by HOST_NAME.
# A domain name beginning by &quot;[www.]domain.tld&quot; gets an extra &quot;domain.tld&quot; in certificate.
# NOTICE #######################################################################

declare -a DOMAINS_NAMES_LIST=(

#&quot;HOST_NAME;HOST_LOGIN;HOST_FQDN,HOST_PORT;ACCOUNT_NAME;DOMAIN_NAME;[DOMAIN_STATUS]&quot;


&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_ONE;www.domain1.tld&quot;
&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_ONE;www.domain2.tld&quot;

&quot;rs11domu110;root;domu110v1;45678;ACCOUNT_NAME_TWO;www.domain3.tld&quot;
&quot;rs11domu110;root;domu110v1;45678;ACCOUNT_NAME_TWO;www.domain6.tld&quot;
&quot;rs11domu110;root;domu110v1;45678;ACCOUNT_NAME_TWO;www.domain4.tld&quot;
&quot;rs11domu110;root;domu110v1;45678;ACCOUNT_NAME_TWO;www.domain5.tld&quot;

&quot;rs11domu001;root;domu110v1;45678;ACCOUNT_NAME_ONE;www.domain8.tld&quot;
&quot;rs11domu001;root;domu110v1;45678;ACCOUNT_NAME_TWO;www.domain7.tld&quot;

&quot;rs11domu120;root;domu120v1;61234;ACCOUNT_NAME_ONE;www.domain9.tld&quot;

&quot;rs11domu210;root;domu210v1;18023;ACCOUNT_NAME_FIFTEEN;www.domainN.tld&quot;


# DO NOT DELETE THE LINE BELOW #################################################
&quot;null;null;null;null;null;null&quot;
# DO NOT DELETE THE LINE ABOVE #################################################
)

#-------------------------------------------------------------------------------
# EOF
#-------------------------------------------------------------------------------</code></pre>
<p>When creating certificate which starts with &quot;www.&quot; (like &quot;www.domain.tld&quot;), <strong>acmemgr.sh</strong> automatically adds the domain name &quot;domain.tld&quot; in certificate. This behaviour is useful to handle gracefully all uses cases : http://domain.tld, http://www.domain.tld, https://domain.tld, https://www.domain.tld.</p>
<p>If you reuse some existing certificates, tag them CREATED :</p>
<pre><code># A Domain already created

&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_ONE;www.domain1.tld;CREATED&quot;</code></pre>
<h2 id="setting-up-one-dns-01-account">Setting up one DNS-01 account</h2>
<p>The following is about the <strong>first</strong> account named <strong>ACCOUNT_NAME_ONE</strong> (repeat the process for each new account).</p>
<h3 id="create-account-structure">Create account structure</h3>
<p>Create DNS-01 <strong>ACCOUNT_NAME_ONE</strong> account directory and copy dnsapi directory:</p>
<pre><code>root@system: mkdir /etc/acme/ACCOUNT_NAME_ONE
root@system: cp -r /root/acme/dnsapi /etc/acme/ACCOUNT_NAME_ONE</code></pre>
<p>Create /etc/acme/<strong>ACCOUNT_NAME_ONE</strong>/account.conf containing :</p>
<pre><code>ACCOUNT_CONF_PATH=&quot;/etc/acme/ACCOUNT_NAME_ONE/myaccount.conf&quot;</code></pre>
<p>Create /etc/acme/<strong>ACCOUNT_NAME_ONE</strong>/myaccount.conf containing :</p>
<pre><code>LOG_FILE=&#39;/var/log/acme/ACCOUNT_NAME_ONE.log&#39;
LOG_LEVEL=1

#AUTO_UPGRADE=&quot;1&quot;
#NO_TIMESTAMP=1

ACCOUNT_DNS01=&quot;dns_ovh&quot;
    
CERT_HOME=&#39;/etc/acme/certs&#39;
ACCOUNT_KEY_PATH=&#39;/etc/acme/ACCOUNT_NAME_ONE/myaccount.key&#39;
USER_AGENT=&#39;acme client&#39;
ACCOUNT_EMAIL=&#39;your@email.adress&#39;</code></pre>
<p>All variables are only used by acme.sh, except for three :</p>
<ul>
<li>ACCOUNT_DNS01 will be used consistently by <strong>acmemgr.sh</strong> and acme.sh.</li>
<li>CERT_HOME will be used consistently by <strong>acmemgr.sh</strong> and acme.sh.</li>
<li>ACCOUNT_EMAIL will be used for two purposes: through acme.sh, Let's Encrypt will be able to sent you messages (about the near expiring certificates, for example) and <strong>acmemgr.sh</strong> will be able to sent you all events about yours certificates management.</li>
</ul>
<h3 id="filling-the-account-keys-and-secret">Filling the account keys and secret</h3>
<p>Assuming your <strong>first</strong> DNS-01 account is hosted at <strong>OVH</strong> and you obtained <strong>AK-KEY</strong>, <strong>AS-SECRET</strong> and <strong>CK-KEY</strong> from your OVH personal web page account.</p>
<p>Update the beginning of /etc/acme/<strong>ACCOUNT_NAME_ONE</strong>/dnsapi/<strong>dns_ovh.sh</strong>.</p>
<pre><code># Application Key
OVH_AK=&quot;AK-KEY&quot;
# Application Secret
OVH_AS=&quot;AS-SECRET&quot;
# Consumer Key
OVH_CK=&quot;CK-KEY&quot;
…/…
# End-point
OVH_END_POINT=ovh-eu -- Choose the best location for you
…/…</code></pre>
<h3 id="rotate-log">Rotate log</h3>
<p>Update /etc.logrotate.d/acme :</p>
<pre><code>/var/log/acme/ACCOUNT_NAME_ONE.log {
  rotate 12
  monthly
  compress
  missingok
  notifempty
}</code></pre>
<p><strong>Repeat this section for each new DNS-01 account.</strong></p>
<h2 id="setting-up-one-host">Setting up one host</h2>
<p>acmemgr.sh is designed to be used in a non limited VM numbers, which each VM hosting only one service type.</p>
<p>Mixed hosting of services like web and email servers is not recommended, as certificates pathes and ways of service reload will be certainly differents.</p>
<p>So we can defined two customizable scripts to:</p>
<ul>
<li>Certificates files operations (currently copy and delete), named HOST_NAME.certops;</li>
<li>Reload the certificates dependent service, named HOST_NAME.reload.</li>
</ul>
<p>HOST_NAME is the field HOST_NAME defined in acmemgr.db</p>
<h3 id="host_name.certops">HOST_NAME.certops</h3>
<pre><code>#----------------------------------------------------------------------------
# ACMEMGR.SH : an ACME.SH manager using DNS-01 issued LETSENCRYPT certificates
#
# HOST_NAME.certops - Distant certificates files operations for common uses (Nginx, etc...)
#----------------------------------------------------------------------------

if [ &quot;${DOMAIN_STATUS:0:7}&quot; == &quot;${DOMAIN_STATUS_DELETING:0:7}&quot; ]; then

  # Safe delete without using recursive remove. In ${CERT_DIR}, delete 7 files {HOST_FQDN}.cer/.conf/.csr/.csr.conf/.key,ca.cer,fullchain.cer, then remove ${CERT_DIR}

  ssh -p ${HOST_PORT} ${HOST_LOGIN}@${HOST_FQDN} &quot;rm --force ${CERT_DIR}/${DOMAIN_NAME}.cer ${CERT_DIR}/${DOMAIN_NAME}.conf ${CERT_DIR}/${DOMAIN_NAME}.csr ${CERT_DIR}/${DOMAIN_NAME}.csr.conf ${CERT_DIR}/${DOMAIN_NAME}.key ${CERT_DIR}/${CERT_CA} ${CERT_DIR}/${CERT_FULLCHAIN} ; rmdir ${CERT_DIR}&quot;

  # Directory check : return 0 if ${CERT_DIR} does not exist, 1 if if ${CERT_DIR} exist

  ssh -p ${HOST_PORT} ${HOST_LOGIN}@${HOST_FQDN} &quot;[ ! -d ${CERT_DIR} ]&quot;

else

  # Create domain name directory ${CERT_DIR} in {HOST_FQDN}:${CERT_DIR}

  ssh -p ${HOST_PORT} ${HOST_LOGIN}@${HOST_FQDN} &quot;mkdir -p ${CERT_DIR}&quot;

  # Copy certificates files ${DOMAIN_KEY} and ${DOMAIN_CERT} to {HOST_FQDN}:${CERT_DIR}/

  scp -P ${HOST_PORT} ${DOMAIN_KEY} ${DOMAIN_CERT} ${HOST_LOGIN}@${HOST_FQDN}:${CERT_DIR}/

fi

#----------------------------------------------------------------------------
# EOF
#----------------------------------------------------------------------------</code></pre>
<h3 id="host_name.reload">HOST_NAME.reload</h3>
<pre><code>#!/bin/bash
#----------------------------------------------------------------------------
# ACMEMGR.SH : an ACME.SH manager using DNS-01 issued LETSENCRYPT certificates
#
# nginx.reload -  Nginx smart reload (see documentation)
#----------------------------------------------------------------------------

systemctl reload nginx

#----------------------------------------------------------------------------
# EOF
#----------------------------------------------------------------------------</code></pre>
<p><strong>Repeat this section for each new host.</strong></p>
<h2 id="basic-use">Basic use</h2>
<h3 id="command-line">Command line</h3>
<p>Commands (one at a time) :</p>
<ul>
<li>--create - Create non-existent certificate (according to acmemgr.db database)</li>
<li>--renew - Renew certificates (from a month before they expire)</li>
<li>--update - Update certificates (create and delete according to acmemgr.db database)</li>
<li>--copy - Distribute certificates on hosts (dedicated or virtuals)</li>
<li>--delete - Delete certificates (according to acmemgr.db database)</li>
<li>--status - Status of certificates (with validity dates)&quot;</li>
<li>--verbose - Status of certificates (with last operation dates and validity dates)&quot;</li>
<li>--help - Command line help</li>
</ul>
<h3 id="return-codes">Return codes</h3>
<ul>
<li>0 - No fatal error, read acmemgr.log for process related errors</li>
<li>1 - Command error</li>
<li>2 - Domains names datase acmemgr.db not found.</li>
<li>3 - File /etc/acme/ACCOUNT_NAME/myaccount.conf not found.</li>
<li>4 - File /etc/acme/HOST_NAME.certops not found.</li>
<li>5 - File /etc/acme/HOST_NAME.reload not found.</li>
</ul>
<h3 id="using---create">Using --create</h3>
<p>Create untagged Certificates in acmemgr.db.</p>
<p>Check if the certificate does not exist.</p>
<p>Create certificate, through Let's Encrypt.</p>
<p>Copy to distant host the certificates present in acmemgr.db and nonexistent in the certificates directory.</p>
<p>Tag domain(s) name(s) in acmemgr.db as &quot;CREATED - with date and time&quot;.</p>
<p>Log and send mail (info or error).</p>
<h3 id="using---renew">Using --renew</h3>
<p>Renew Certificates tagged &quot;CREATED&quot; or &quot;RENEWED&quot; in acmemgr.db.</p>
<p>Check if the certificate already exists.</p>
<p>Renew certificates, through Let's Encrypt, only when they are two months old.</p>
<p>Tag domain(s) name(s) in acmemgr.db as &quot;RENEWED - with date and time&quot;.</p>
<p>Log and send mail (info or error).</p>
<h3 id="using---update">Using --update</h3>
<p>Create and delete certificates in one pass.</p>
<p>See --create and --delete paragraphs for further information.</p>
<h3 id="using---copy">Using --copy</h3>
<p>Check if the certificate already exists.</p>
<p>Copy certificates files to distant hosts.</p>
<p>Log and send mail (info or error).</p>
<h3 id="using---delete">Using --delete</h3>
<p>Delete Certificates tagged &quot;DELETING&quot; in acmemgr.db.</p>
<p>Check if the certificate already exists.</p>
<p>Revoke certificate through Let's Encrypt.</p>
<p>Delete certificates files on remote host.</p>
<p>Tag domain(s) name(s) in acmemgr.db as &quot;DELETED - with date and time&quot;.</p>
<p>Log and send mail (info or error).</p>
<h3 id="using---status">Using --status</h3>
<p>Check certificates status and validity dates.</p>
<pre><code>Sowebio SARL (R) An acme.sh manager using DNS-01 protocol. Version 0.6
Copyright    (C) Stephane Riviere 2017-2018, according to GPLv3 or greater.

Certificate: w978.domain.tld             CREATION (in progress)
Certificate: w979.domain.tld             CREATED                 notBefore=Feb 12 13:42:13 2018 GMT notAfter=May 13 13:42:13 2018 GMT 
Certificate: w980.domain.tld             CREATED                 notBefore=Feb 12 13:25:25 2018 GMT notAfter=May 13 13:25:25 2018 GMT 
Certificate: w980.domain.tld             DELETED 
Certificate: w981.domain.tld             DELETED </code></pre>
<h3 id="using---verbose">Using --verbose</h3>
<p>Check certificates status, last operation dates and validity dates.</p>
<pre><code>Sowebio SARL (R) An acme.sh manager using DNS-01 protocol. Version 0.6
Copyright    (C) Stephane Riviere 2017-2018, according to GPLv3 or greater.

Certificate: w978.domain.tld             CREATED - lundi 12 février 2018, 17:08:44 (UTC+0100)            notBefore=Feb 12 15:08:33 2018 GMT notAfter=May 13 15:08:33 2018 GMT 
Certificate: w979.domain.tld             CREATED - lundi 12 février 2018, 15:25:36 (UTC+0100)            notBefore=Feb 12 13:42:13 2018 GMT notAfter=May 13 13:42:13 2018 GMT 
Certificate: w980.domain.tld             CREATED - lundi 12 février 2018, 15:25:36 (UTC+0100)            notBefore=Feb 12 13:25:25 2018 GMT notAfter=May 13 13:25:25 2018 GMT 
Certificate: w980.domain.tld             DELETED - lundi 12 février 2018, 15:58:39 (UTC+0100)
Certificate: w981.domain.tld             DELETED - lundi 12 février 2018, 15:59:56 (UTC+0100)</code></pre>
<h2 id="high-level-use">High level use</h2>
<p>Once installed and set, this is the way to use <strong>acmemgr.sh</strong> on a day by day basis.</p>
<h3 id="batch-mode">Batch mode</h3>
<p>When <strong>acmemgr.sh</strong> is renamed acmemgr.renew and placed in /etc/cron.weekly :</p>
<ul>
<li>Checking every week certificates renewing.</li>
</ul>
<p>When <strong>acmemgr.sh</strong> is renamed acmemgr.update and placed in /etc/cron.hourly :</p>
<ul>
<li>Updating certificates pool every hour by creating and deleting them according to the file acmemgr.db</li>
</ul>
<h3 id="create-a-certificate">Create a certificate</h3>
<p>Create a new line in acmemgr.db :</p>
<pre><code>&quot;rs11domu120;root;domu120v1;61234;ACCOUNT_NAME_THREE;www.domain5.tld&quot;</code></pre>
<p>One hour later max, depending of your cron, the certificate is created :</p>
<pre><code>&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_ONE;wwmarkdownw.domain1.tld;CREATED - lundi 12 fevrier 2018, 17:13:11 (UTC+0100)&quot;</code></pre>
<p>Two monts later, more or less one week, the certificated is renewed :</p>
<pre><code>&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_ONE;www.domain1.tld;RENEWED - jeudi 26 avril 2018, 18:13:11 (UTC+0100)&quot;</code></pre>
<h3 id="delete-a-certificate">Delete a certificate</h3>
<p>Update the domain name related line :</p>
<pre><code>&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_ONE;www.domain1.tld;RENEWED - jeudi 26 avril 2018, 18:13:11 (UTC+0100)&quot;</code></pre>
<p>Replacing CREATED or RENEWED by DELETING :</p>
<pre><code>&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_ONE;www.domain1.tld;DELETING - jeudi 26 avril 2018, 18:13:11 (UTC+0100)&quot;</code></pre>
<p>One hour later max, depending of your cron, the certificate is deleted :</p>
<pre><code>&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_ONE;www.domain1.tld;DELETED - jeudi 26 avril 2018, 19:13:11 (UTC+0100)&quot;</code></pre>
<h2 id="real-world-workflow">Real world workflow</h2>
<p>We set up two new domain names:</p>
<pre><code>&quot;rs11domu120;root;domu120v1;61234;ACCOUNT_NAME_THREE;www.domain9.tld&quot;
&quot;rs11domu120;root;domu120v1;61234;ACCOUNT_NAME_THREE;wiki.domain9.tld&quot;</code></pre>
<p>After the cron, we get:</p>
<pre><code>&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_THREE;www.domain9.tld;CREATED - lundi 12 fevrier 2018, 17:13:11 (UTC+0100)&quot;
&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_THREE;wiki.domain9.tld;CREATED - lundi 12 fevrier 2018, 17:14:31 (UTC+0100)&quot;</code></pre>
<p>But we change our mind and finally go for a wildcard certificate. We now tag the just created certificates as to be deleted (no need to delete the previous datetime tag) and create a new wildcard certificate:</p>
<pre><code>&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_THREE;www.domain9.tld;DELETING - lundi 12 fevrier 2018, 17:13:11 (UTC+0100)&quot;
&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_THREE;wiki.domain9.tld;DELETING - lundi 12 fevrier 2018, 17:13:11 (UTC+0100)&quot;
&quot;rs11domu120;root;domu120v1;61234;ACCOUNT_NAME_THREE;*.domain9.tld&quot;</code></pre>
<p>One cron cycle after, we get:</p>
<pre><code>&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_THREE;www.domain9.tld;DELETED - lundi 12 fevrier 2018, 18:13:11 (UTC+0100)&quot;
&quot;rs11domu010;root;domu010v1;12345;ACCOUNT_NAME_THREE;wiki.domain9.tld;DELETED - lundi 12 fevrier 2018, 18:13:31 (UTC+0100)&quot;
&quot;rs11domu120;root;domu120v1;61234;ACCOUNT_NAME_THREE;*.domain9.tld;CREATED - lundi 12 fevrier 2018, 18:15:41 (UTC+0100)&quot;</code></pre>
<h3 id="good-practises">Good practises</h3>
<p>To keep the file readable, you may choose, from time to time, to delete the certificates lines tagged DELETED.</p>
<p>Remember that all directories and certificates are propagated and deleted in all relevant hosts. SSL integration in seconds of 10 or 20 additional sites is no longer a problem and become a standard task. On the nginx side, standardized conf files using the include directive will also make integration easy:</p>
<pre><code>#-----------------------------------------------------------------------------
# www.soweb.io - proxy side
#-----------------------------------------------------------------------------
#
# 20170803 - initial release
#
#-----------------------------------------------------------------------------

include /etc/nginx/inc/ssl.conf; # SSL

ssl_certificate         /etc/acme/certs/www.soweb.io/fullchain.cer;
ssl_certificate_key     /etc/acme/certs/www.soweb.io/www.soweb.io.key;
ssl_trusted_certificate /etc/acme/certs/www.soweb.io/fullchain.cer; # For OCSP Stapling
access_log               /var/log/nginx/www.soweb.io.access.log;
error_log                /var/log/nginx/www.soweb.io.error.log;

#-----------------------------------------------------------------------------
# EOF
#-----------------------------------------------------------------------------</code></pre>
<h2 id="multi-accounts-tree-example">Multi-accounts tree example</h2>
<pre><code>* Installation tree (local host)

/usr/local/bin                        (scripts)
             acme.sh
             acmemgr.sh
/etc/acme
           acmemgr.db
           HOST_NAME_ONE.copy
           HOST_NAME_ONE.reload
                    .
                    .
           HOST_NAME_N.certops
           HOST_NAME_N.reload

/etc/acme/ACCOUNT_NAME_ONE            (accounts)
                .    /dnsapi
                .    account.conf
                    .    myaccount.conf
/etc/acme/ACCOUNT_NAME_N
                        /dnsapi
                            account.conf
                            myaccount.conf
/etc/acme/certs                       (certificates)
                /DOMAIN_NAME_ONE
                         .
                         .
                /DOMAIN_NAME_N
/var/log/acme                         (logs)
      ACCOUNT_NAME_ONE.log
        ACCOUNT_NAME_N.log
        acmemgr.log

* Installation tree (distant hosts) - could be changed in HOST_NAME_N.certops

/etc/acme/certs                       (certificates)
              /DOMAIN_NAME_ONE/
                       .     fullchain.cer
                       .     DOMAIN_NAME_ONE.key
                       .
              /DOMAIN_NAME_N/
                             fullchain.cer
                             DOMAIN_NAME_N.key</code></pre>
<h2 id="build-instructions">Build Instructions</h2>
<h3 id="software">Software</h3>
<p>N/A</p>
<h3 id="documentation">Documentation</h3>
<p>This documentation (html5 format):</p>
<pre><code>root@system: pandoc README.md --css README.css -o README.html</code></pre>
<p>This documentation (LibreOffice format):</p>
<pre><code>root@system: pandoc README.md -V geometry:margin=1cm -s -o README.html</code></pre>
<p>Pretty-printing source (html5 format):</p>
<pre><code>root@system: source-highlight --line-number --src-lang bash --out-format html5 --doc acmemgr.sh</code></pre>
<p>Pretty-printing source (LibreOffice format):</p>
<pre><code>root@system:source-highlight --line-number --src-lang bash --out-format odf --doc acmemgr.sh</code></pre>
<h2 id="releases-log">Releases log</h2>
<ul>
<li>20170731 : <strong>0.1</strong> - sr - Initial release</li>
<li>20171103 : <strong>0.2</strong> - sr - Unmarked release</li>
<li>20171119 : <strong>0.3</strong> - sr - Adding the OVH account as a parameter</li>
<li>20180201 : <strong>0.4</strong> - sr - Full rewrite in a single common script</li>
<li>20180209 : <strong>0.5</strong> - sr - Finish delete command and add updates argument</li>
<li>20180212 : <strong>0.6</strong> - sr - Hardened code and extensive tests</li>
<li>20180213 : <strong>0.7</strong> - sr - In production</li>
<li>20180315 : <strong>0.8</strong> - sr - When creating certificate which starts with &quot;www.&quot; (like &quot;www.domain.tld&quot;), acmemgr.sh automatically adds the domain name &quot;domain.tld&quot; in certificate. Email messages improvements: The subject of the message is more explicit and there is no need, in most cases, to open the message to read it in full. Email messages bug : a success message in renewing was tagged as an error. File example bug : in mailcow_example.certops, the destination certificates files were reversed. Documentation improvements and typos correction. Css style for html rendering has been improved.</li>
<li>20180329 : <strong>0.9</strong> - sr ss - acmemgr.sh and acme.sh now share the same path to certificates. Deleting CERT_ROOT variable, which was statically defined to /etc/acme/certs in acmemgr.sh. acemmgr.sh now uses CERT_HOME, which is defined in each configuration file myaccount.conf of every DNS account. CERT_HOME is used in all acme.sh certificates operation through the --cert-home parameter. Validate wild certificates creation (which was not tested or supported): while the creation itself was successful, the update of acme mgr.db was wrong, because of the special character status of the * (star) character. Check create, renew and revoke cycle with a test wild certificate. Documentation improvements and typos correction.</li>
<li>20180430 : <strong>1.0</strong> - sr - Documentation improvements and typos correction. Add quick link table. Move to Sowebio Github account.</li>
</ul>
<p>sr : see below <strong>Contact</strong></p>
<p>ss : Somanos Sar - somanos(at)drumee.net : Has pointed out the inconsistencies in defining the certificates directory between amcemgr.sh and acme.sh.</p>
<h2 id="miscellaneous"> Miscellaneous</h2>
<h3 id="localization">Localization</h3>
<p>Not planned.</p>
<h3 id="known-bugs">Known bugs</h3>
<p>All for my own. Bugs reports are welcome.</p>
<h3 id="roadmap">Roadmap</h3>
<p>None for my own. Suggestions are welcome.</p>
<h3 id="contact">Contact</h3>
<p>Email to : <a href="mailto:stef@genesix.org">stef@genesix.org</a></p>
<h3 id="licence">Licence</h3>
<p>Copyright (C) Stephane Riviere 2017-2018, according to GPLv3 or greater, for <a href="https://soweb.io" class="uri">https://soweb.io</a> SARL France.</p>
<h1 id="appendices">APPENDICES</h1>
<h2 id="when-something-going-wrong">When something going wrong</h2>
<p>If you already had some Let's Encrypt certificates before using acmemgr.sh. Check their .conf files to be sure that informations inside are good. Le_Webroot and Le_NextRenewTime should be consistent.</p>
<p>Challenge error: {&quot;type&quot;:&quot;urn:acme:error:malformed&quot;,&quot;detail&quot;:&quot;Expired authorization&quot;,&quot;status&quot;: 404} : Check Le_NextRenewTime or Le_NextRenewTimeStr : you're attempted to renew an obsolete certificate.</p>
<h2 id="lets-encrypt-certificate-files">Let's Encrypt certificate files</h2>
<table>
<colgroup>
<col width="27%" />
<col width="54%" />
<col width="18%" />
</colgroup>
<thead>
<tr class="header">
<th align="left"></th>
<th align="left">DNS-01</th>
<th align="left">HTTP-01</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Certificate</td>
<td align="left">/etc/acme/certs/www.domain.tld/www.domain.tld.cer</td>
<td align="left">cert.pem</td>
</tr>
<tr class="even">
<td align="left">Certificate private key</td>
<td align="left">/etc/acme/certs/www.domain.tld/www.domain.tld.key</td>
<td align="left">privkey.pem</td>
</tr>
<tr class="odd">
<td align="left">Intermediate CA cert</td>
<td align="left">/etc/acme/certs/www.domain.tld/ca.cer</td>
<td align="left">chain.pem</td>
</tr>
<tr class="even">
<td align="left">Full chain certs</td>
<td align="left">/etc/acme/certs/www.domain.tld/fullchain.cer</td>
<td align="left">fullchain.pem</td>
</tr>
<tr class="odd">
<td align="left">Certificate conf</td>
<td align="left">/etc/acme/certs/www.domain.tld.conf</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Certificate request conf</td>
<td align="left">/etc/acme/certs/www.domain.tld.csr.conf</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Certificate request</td>
<td align="left">/etc/acme/certs/www.domain.tld.csr</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h2 id="lets-encrypt-certificate-.conf-format">Let's Encrypt certificate .conf format</h2>
<p>This file is usually located at /etc/acme/certs/www.domain.tld</p>
<pre><code>Le_Domain=&#39;www.domain.tld&#39;
Le_Alt=&#39;no&#39;
Le_Webroot=&#39;dns_ovh&#39;
Le_PreHook=&#39;&#39;
Le_PostHook=&#39;&#39;
Le_RenewHook=&#39;&#39;
Le_API=&#39;https://acme-v01.api.letsencrypt.org/directory&#39;
Le_Keylength=&#39;&#39;
Le_LinkCert=&#39;https://acme-v01.api.letsencrypt.org/acme/cert/03e781ca2e09b6c9f20792bae9f67a8edbcf&#39;
Le_LinkIssuer=&#39;https://acme-v01.api.letsencrypt.org/acme/issuer-cert&#39;
Le_CertCreateTime=&#39;1521110878&#39;
Le_CertCreateTimeStr=&#39;jeudi 15 mars 2018, 10:47:58 (UTC+0000)&#39;
Le_NextRenewTimeStr=&#39;lundi 14 mai 2018, 10:47:58 (UTC+0000)&#39;
Le_NextRenewTime=&#39;1526208478&#39;</code></pre>
<p>Notes :</p>
<ul>
<li>If you shift the domain name from a DNS account (dns_ovh) to another (dns_freedns), you must change Le_Webroot field accordingly. i.e. change Le_Webroot='dns_ovh' to Le_Webroot='dns_freedns'</li>
<li>If you want to modify the renew date, for tests purposes, you may use https://www.epochconverter.com to adjust the Le_NextRenewTime='1526208478' field (seconds since 19700101)</li>
</ul>
<h2 id="nginx-reloading">Nginx reloading</h2>
<p>Information about how to handle certificates updates with Nginx without restarting the service.</p>
<h3 id="check-your-system">Check your system</h3>
<p>If your system use systemd, chances are high that the reload nginx native command is:</p>
<pre><code>root@system: systemctl reload nginx</code></pre>
<h3 id="check-execreload-property">Check ExecReload property</h3>
<p>Result could slightly change across systems:</p>
<pre><code>root@system: systemctl show nginx.service --property=ExecReload

ExecReload={ path=/usr/sbin/nginx ; argv[]=/usr/sbin/nginx -g daemon on; master_process on; -s reload ; ignore_errors=no ; start_time=[n/a] ; stop_time=[n/a] ; pid=0 ; code=(null) ; status=0/0 }</code></pre>
<p>The important part is:</p>
<pre><code> -s reload ;</code></pre>
<p>The parameter <strong>-s</strong> send a signal to the master process. The argument signal can be one of: stop, quit, reopen, <strong>reload</strong>, according to the following table:</p>
<ul>
<li>stop SIGTERM</li>
<li>quit SIGQUIT</li>
<li>reopen SIGUSR1</li>
<li><strong>reload SIGHUP</strong></li>
</ul>
<p>According to http://nginx.org/en/docs/control.html, the <strong>reload SIGHUP</strong> signal: - changing configuration, - keeping up with a changed time zone (only for FreeBSD and Linux) - starting new worker processes with a new configuration - graceful shutdown of old worker processes</p>
<p>As per http://nginx.org/docs/control.html#reconfiguration, sending the HUP signal to nginx makes sure that it performs a graceful restart, and, if the configuration files are incorrect, the whole procedure is abandoned, and you're left with the nginx as before sending the HUP signal. At no point should any downtime be possible : - The master process first checks the syntax validity, then tries to apply new configuration, that is, to open log files and new listen sockets. - If this fails, it rolls back changes and continues to work with old configuration.</p>
<h2 id="glossary">Glossary</h2>
<p>Some common concepts in cryptography are found around <strong>acmemgr.sh</strong> :</p>
<ul>
<li>Let's Encrypt is CEC ;</li>
<li>The Certificate Distribution Server is CDES, a part of the secure SGC.</li>
</ul>
<table>
<colgroup>
<col width="10%" />
<col width="50%" />
<col width="40%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Initials</th>
<th align="left">French</th>
<th align="left">English</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">SGC</td>
<td align="left">Systeme de Gestion Centralise</td>
<td align="left">Centralized Management System</td>
</tr>
<tr class="even">
<td align="left">CEC</td>
<td align="left">Centre d'Elaboration des cles</td>
<td align="left">Key Development Center</td>
</tr>
<tr class="odd">
<td align="left">CDES</td>
<td align="left">Centre de Distribution des Elements Secrets</td>
<td align="left">Secret Element Distribution Center</td>
</tr>
</tbody>
</table>
<h2 id="test-set">Test set</h2>
<h3 id="test-01---run-the-program-without-arguments">Test 01 - Run the program without arguments</h3>
<ul>
<li>Objective : See the help screen</li>
<li>Prior action : None</li>
<li>root@system: acmemgr.sh</li>
<li>Result: OK</li>
</ul>
<h3 id="test-02---check-the-status-listing">Test 02 - Check the status listing</h3>
<ul>
<li>Objective : See status output</li>
<li>Prior action : None</li>
<li>root@system: acmemgr.sh --status</li>
<li>Result: OK</li>
</ul>
<h3 id="test-03---check-the-verbose-listing">Test 03 - Check the verbose listing</h3>
<ul>
<li>Objective : See verbose output</li>
<li>Prior action : None</li>
<li>root@system: acmemgr.sh --verbose</li>
<li>Result: OK</li>
</ul>
<h3 id="test-04---create-one-new-domain-certificate">Test 04 - Create one new domain certificate</h3>
<ul>
<li>Objective : Create a domain name and check certificate copy on the distant host. Check tag CREATED</li>
<li>Prior action : Fill a new domain name in acmemgr.db</li>
<li>root@system: acmemgr.sh --create</li>
<li>Result: OK</li>
</ul>
<h3 id="test-05---delete-one-domain-certificate">Test 05 - Delete one domain certificate</h3>
<ul>
<li>Objective : Delete a domain name and check certificate deletion on the distant host. Check tag DELETED at DATE - TIME replacement</li>
<li>Prior action : Tag a domain name with &quot;DELETING&quot; field</li>
<li>root@system: acmemgr.sh --delete</li>
<li>Result: OK</li>
</ul>
<h3 id="test-06---create-three-new-domains-certificates-and-delete-three-others">Test 06 - Create three new domains certificates and delete three others</h3>
<ul>
<li>Objective : Check chained creations and deletions</li>
<li>Prior action : Fill 3 new domains names and tag three others domain names for DELETING in acmemgr.db, Check tags updates.</li>
<li>root@system: acmemgr.sh --update</li>
<li>Result: OK</li>
</ul>
<h3 id="test-07---check-acmemgr.updates">Test 07 - Check acmemgr.updates</h3>
<ul>
<li>Objective : Check acmemgr.update in cron.hourly</li>
<li>Prior action : Copy acmemgr.sh to /etc/cron.houlry/acmemgr.update and fill some domains names creation, then some domains names deletion</li>
<li>root@system: None</li>
<li>Result: OK</li>
</ul>
<h3 id="test-08---check-acmemgr.renew">Test 08 - Check acmemgr.renew</h3>
<ul>
<li>Objective : Check acmemgr.renew cron.weekly</li>
<li>Prior action : Copy acmemgr.sh to /etc/cron.weekly/acmemgr.renew. Uncommented the 4 months test check (instead of 1 monts) and manually launch acmemgr.renew. Then simulate a full renew with --force acme.sh argument in command.</li>
<li>root@system: None</li>
<li>Result: OK</li>
</ul>
</body>
</html>
